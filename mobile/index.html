<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecycleRight CA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="../manifest.webmanifest" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<style>
  .animate-fade-in {
    animation: fadeIn 0.8s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes bounce {
    0% {
      transform: translateY(-20%);
    }

    50% {
      transform: translateY(0%);
    }

    70% {
      transform: translateY(-10%);
    }

    100% {
      transform: translateY(0);
    }
  }
</style>

<body class="h-full bg-gray-100 flex flex-col">
  <header class="bg-green-600 text-white text-center py-3 shadow-md">
    <h1 class="text-xl font-semibold animate-fade-in">RecycleRight&nbsp;CA</h1>
  </header>

  <main id="pages" class="flex-1 overflow-auto">
    <section id="page-main" class="p-6 space-y-6">
      <div class="text-center max-w-md mx-auto">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Your Pocket Recycling Coach</h2>
        <p class="text-gray-600">Snap a product and find out if it‚Äôs recyclable or refundable!</p>
      </div>
      <div class="w-full max-w-sm mx-auto space-y-4">
        <button id="scanBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-green-600 text-white rounded-xl shadow hover:bg-green-700 transition-all text-lg">
          <span class="material-icons-outlined">photo_camera</span>
          Snap Item
        </button>
        <button id="quickMapBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-xl shadow hover:bg-blue-700 transition-all text-lg">
          <span class="material-icons-outlined">map</span>
          Nearest Buy-Back Center
        </button>
      </div>
      <section id="result" class="hidden w-full max-w-md mx-auto bg-white p-4 rounded-lg shadow animate-fade-in">
      </section>
    </section>
    <div id="camera" class="hidden p-4 text-center animate-fade-in"></div>
    <div id="loadingSpinner" class="hidden text-center p-4 animate-pulse">
      <p>üîç Analyzing image...</p>
    </div>
    <section id="page-map" class="hidden p-0">
      <div id="map" style="height: calc(100vh - 112px);" class="w-full"></div>
    </section>
    <section id="page-profile" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Profile</h2>
      <div id="profileContent" class="bg-white p-4 rounded-lg shadow text-center space-y-2"></div>
    </section>
    <section id="page-settings" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Settings</h2>
      <p>üîß Settings coming soon‚Ä¶</p>
    </section>
  </main>

  <nav class="bg-white shadow-inner border-t border-gray-200 flex justify-around py-2 text-sm">
    <button data-tab="main" class="tab flex flex-col items-center text-green-600">
      <span class="material-icons-outlined text-xl">home</span>
      <span>Main</span>
    </button>
    <button data-tab="map" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">map</span>
      <span>Map</span>
    </button>
    <button data-tab="profile" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">person</span>
      <span>Profile</span>
    </button>
    <button data-tab="settings" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">settings</span>
      <span>Settings</span>
    </button>
  </nav>

  <div id="signinModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl w-80 p-6 space-y-4 text-center animate-fade-in">
      <h3 class="text-lg font-semibold">Sign In</h3>
      <p class="text-sm text-gray-600">Sign in to save history, earn points, and rise in rank.</p>
      <input id="usernameInput" class="w-full border border-gray-300 rounded p-2" placeholder="Enter a nickname" />
      <button id="signinConfirm"
        class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Continue</button>
      <button id="signinCancel" class="w-full px-4 py-2 text-sm text-gray-500">Maybe later</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const tabs = document.querySelectorAll('.tab');
    const pages = { main: 'page-main', map: 'page-map', profile: 'page-profile', settings: 'page-settings' };
    let map = null;
    let mapReady = false;
    const GEMINI_API_KEY = "AIzaSyCteI1RtEohJ7bMCNcJt3sUdROp_ZlVx4E";

    function switchTab(tab) {
      tabs.forEach(t => {
        const active = t.dataset.tab === tab;
        t.classList.toggle('text-green-600', active);
        t.classList.toggle('text-gray-500', !active);
        document.getElementById(pages[t.dataset.tab]).classList.toggle('hidden', !active);
      });
      if (tab === 'map' && !mapReady) initMap();
    }
    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
    switchTab('main');

    const nearestBtn = document.getElementById('nearestBtn');

    const resultDiv = document.getElementById('result');
    const cameraDiv = document.getElementById('camera');
    const loadingSpinner = document.getElementById('loadingSpinner');

    document.getElementById('scanBtn').addEventListener('click', async () => {
      resultDiv.classList.add('hidden');
      cameraDiv.innerHTML = '';
      cameraDiv.classList.remove('hidden');

      const video = document.createElement('video');
      video.setAttribute('autoplay', '');
      video.setAttribute('playsinline', '');
      video.className = 'rounded shadow-md';
      video.style.width = '100%';
      cameraDiv.appendChild(video);

      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;

      const snapBtn = document.createElement('button');
      snapBtn.textContent = 'üì∏ Take Photo';
      snapBtn.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700';
      cameraDiv.appendChild(snapBtn);

      snapBtn.addEventListener('click', async () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        stream.getTracks().forEach(track => track.stop());
        cameraDiv.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
        sendToGemini(base64);
      });
    });

    async function sendToGemini(base64img) {
      const body = {
        contents: [{
          parts: [
            {
              inline_data: {
                mime_type: 'image/jpeg',
                data: base64img
              }
            },
            {
              text: `Analyze this item. Detect the item, detect whether it is recyclable or not.
    If the item is recyclable, determine if it most likely is CRV. If it is, estimate return amount money.
    Here is a list of items usually listed as CRV:
      - Glass Beer and other malt bottles
      - Glass wine coolers
      - Plastic Soda bottles and aluminum cans
      - Plastic water bottles
      - Plastic sports drinks bottles
      - Tea and coffee drinks
      - Juice cans and bottles (100% juice containers need to be less than 46 ounces)
      - Vegetable juice (less than 16 ounces)

    PLEASE ONLY RESPOND WITH ONE OF THESE:
    [RECYCABLE, (ITEM NAME)]
    [NON-R, (ITEM NAME)]
    [CRV, (ESTIMATED-MONEY)]

    Example:
    [RECYCABLE, Plastic Lid]
    [NON-R, Metal Water Bottle]
    [CRV, $0.20]`
            }
          ]
        }]
      };

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        const text = data.candidates[0]?.content?.parts[0]?.text.trim();
        showResult(text);

      } catch (err) {
        console.error('Gemini error:', err);
        resultDiv.innerHTML = '‚ö†Ô∏è Error analyzing image.';
        resultDiv.classList.remove('hidden');
      } finally {
        loadingSpinner.classList.add('hidden');
      }
    }

    function showResult(text) {
      resultDiv.classList.remove('hidden');
      resultDiv.classList.add('fixed', 'inset-0', 'flex', 'flex-col', 'items-center', 'justify-center', 'text-white', 'text-center', 'p-6', 'z-50');
      resultDiv.classList.remove('bg-white');

      if (text.startsWith('[RECYCABLE')) {
        const material = text.split(',')[1].replace(']', '').trim();
        resultDiv.style.backgroundColor = '#16a34a'; // Green
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6 animate-bounce">‚ôªÔ∏è</div>
      <div class="text-3xl font-bold mb-2">Recyclable</div>
      <div class="text-lg">Detected: <strong>${material}</strong></div>
      <button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-green-700 font-semibold rounded-xl">Close</button>
    `;
      } else if (text.startsWith('[NON-R')) {
        const item = text.split(',')[1].replace(']', '').trim();
        resultDiv.style.backgroundColor = '#dc2626'; // Red
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6 animate-bounce">‚ùå</div>
      <div class="text-3xl font-bold mb-2">Not Recyclable</div>
      <div class="text-lg">Detected: <strong>${item}</strong></div>
      <button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-red-700 font-semibold rounded-xl">Close</button>
    `;
      } else if (text.startsWith('[CRV')) {
        const refund = text.split(',')[1].replace(']', '').trim();
        resultDiv.style.backgroundColor = '#facc15'; // Yellow
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6 animate-bounce">üíµ</div>
      <div class="text-3xl font-bold mb-2">CRV Eligible</div>
      <div class="text-lg">Refund: <strong>${refund}</strong></div>
      <button id="nearestBtn" class="mt-6 px-6 py-3 bg-white text-yellow-700 font-semibold rounded-xl">Find Nearest Center</button>
    `;
      } else {
        resultDiv.style.backgroundColor = '#6b7280'; // Gray fallback
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6">‚ùì</div>
      <div class="text-3xl font-bold mb-2">Unknown</div>
      <div class="text-lg">Could not recognize clearly.</div>
      <button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl">Close</button>
    `;
      }
    }

    function closeResult() {
      resultDiv.classList.add('hidden');
      resultDiv.classList.remove('fixed', 'inset-0', 'flex', 'flex-col', 'items-center', 'justify-center', 'text-white', 'z-50');
      resultDiv.style.backgroundColor = '';
      resultDiv.innerHTML = '';
    }

    nearestBtn.onclick = () => {
      resultPage.classList.add('hidden');
      switchTab('map');

      if (!mapReady) {
        initMap().then(() => {
          highlightNearestRecycleCenter();
        });
      } else {
        highlightNearestRecycleCenter();
      }
    };

    function initMap() {
      return new Promise((resolve) => {
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = '<p class="text-center p-4">üìç Getting your location‚Ä¶</p>';

        if (!navigator.geolocation) {
          mapContainer.innerHTML = '<p class="text-center p-4 text-red-600">Geolocation not supported.</p>';
          resolve(); // Still resolve to not freeze
          return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude: lat, longitude: lon } = pos.coords;
          mapContainer.innerHTML = '';
          map = L.map('map').setView([lat, lon], 11);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

          const userIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/727/727634.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
          });

          L.marker([lat, lon], { icon: userIcon }).addTo(map).bindPopup('You are here');

          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
              const userCity = data.address.city || data.address.town || data.address.village || '';
              loadSitesFilteredByCity(userCity).then(() => {
                resolve(); // ‚úÖ Only resolve after loading city centers
              });
            })
            .catch(() => {
              loadSitesFilteredByCity('').then(() => {
                resolve(); // Even if error, still resolve
              });
            });

        }, () => {
          mapContainer.innerHTML = '<p class="text-center p-4 text-red-600">Location error. Allow access and try again.</p>';
          resolve(); // Also resolve if location failed
        });

        mapReady = true;
      });
    }

    function loadSitesFilteredByCity(userCity) {
      fetch('data/crv_centers_address_only.json') // Make sure your JSON is inside /data/
        .then(res => res.json())
        .then(data => {
          let matches = data.filter(site => site.city.toLowerCase() === userCity.toLowerCase());

          if (matches.length === 0 && userCity) {
            const grouped = data.reduce((acc, site) => {
              acc[site.city] = acc[site.city] || [];
              acc[site.city].push(site);
              return acc;
            }, {});
            const fallbackCity = Object.keys(grouped).find(c => c.toLowerCase().includes(userCity.toLowerCase().slice(0, 3)));
            matches = grouped[fallbackCity] || [];
          }

          const recycleIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1327/1327264.png',
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
          });

          matches.forEach(site => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`)
              .then(res => res.json())
              .then(loc => {
                if (loc && loc.length > 0) {
                  const lat = parseFloat(loc[0].lat);
                  const lon = parseFloat(loc[0].lon);
                  const marker = L.marker([lat, lon], { icon: recycleIcon }).addTo(map);
                  marker.bindPopup(`<strong>${site.name}</strong><br>${site.address}<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.full_address)}" target="_blank">Open in Maps</a>`);
                  marker._icon.style.animation = "bounce 0.8s"; // ‚ú® Animate when added
                }
              });
          });
        });
    }

    async function highlightNearestRecycleCenter() {
      const res = await fetch('data/crv_centers_address_only.json');
      const centers = await res.json();

      navigator.geolocation.getCurrentPosition(async pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        let nearest = null;
        let nearestDist = Infinity;

        for (const site of centers) {
          const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`)
            .then(r => r.json());

          if (geo.length > 0) {
            const lat = parseFloat(geo[0].lat);
            const lon = parseFloat(geo[0].lon);
            const dist = Math.sqrt((lat - userLat) ** 2 + (lon - userLon) ** 2);

            if (dist < nearestDist) {
              nearestDist = dist;
              nearest = { lat, lon, name: site.name, address: site.address, full_address: site.full_address };
            }
          }
        }

        if (nearest) {
          const recycleIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1327/1327264.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          });

          const marker = L.marker([nearest.lat, nearest.lon], { icon: recycleIcon }).addTo(map);
          map.setView([nearest.lat, nearest.lon], 15);
          marker.bindPopup(`<strong>${nearest.name}</strong><br>${nearest.address}<br><a href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nearest.full_address)}' target='_blank'>Open in Maps</a>`).openPopup();
        }
      });
    }

  </script>
  <style>
    .animate-fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</body>

</html>