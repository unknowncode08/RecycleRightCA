<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecycleRight CA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="../manifest.webmanifest" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body class="h-full bg-gray-100 flex flex-col">
  <header class="bg-green-600 text-white text-center py-3 shadow-md">
    <h1 class="text-xl font-semibold">RecycleRight&nbsp;CA</h1>
  </header>
  <main id="pages" class="flex-1 overflow-auto">
    <section id="page-main" class="p-6 space-y-6">
      <div class="text-center max-w-md mx-auto">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Your Pocket Recycling Coach</h2>
        <p class="text-gray-600">Scan any item to see if it‚Äôs recycle, trash, or cash-back and find the nearest
          redemption center.</p>
      </div>
      <div class="w-full max-w-sm mx-auto space-y-4">
        <button id="scanBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-green-600 text-white rounded-xl shadow hover:bg-green-700 transition text-lg">
          <span class="material-icons-outlined">photo_camera</span>
          Scan Item
        </button>
        <button id="quickMapBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-xl shadow hover:bg-blue-700 transition text-lg">
          <span class="material-icons-outlined">map</span>
          Nearest Buy-Back Center
        </button>
      </div>
      <section id="result" class="hidden w-full max-w-md mx-auto bg-white p-4 rounded-lg shadow"></section>
    </section>
    <section id="page-map" class="hidden p-0">
      <div id="map" style="height: calc(100vh - 112px);" class="w-full"></div>
    </section>
    <section id="page-profile" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Profile</h2>
      <div id="profileContent" class="bg-white p-4 rounded-lg shadow text-center space-y-2"></div>
    </section>
    <section id="page-settings" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Settings</h2>
      <p>üîß Settings coming soon‚Ä¶</p>
    </section>
  </main>
  <nav class="bg-white shadow-inner border-t border-gray-200 flex justify-around py-2 text-sm">
    <button data-tab="main" class="tab flex flex-col items-center text-green-600">
      <span class="material-icons-outlined text-xl">home</span>
      <span>Main</span>
    </button>
    <button data-tab="map" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">map</span>
      <span>Map</span>
    </button>
    <button data-tab="profile" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">person</span>
      <span>Profile</span>
    </button>
    <button data-tab="settings" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">settings</span>
      <span>Settings</span>
    </button>
  </nav>
  <div id="signinModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl w-80 p-6 space-y-4 text-center">
      <h3 class="text-lg font-semibold">Sign In</h3>
      <p class="text-sm text-gray-600">Sign in to save history, earn points, and rise in rank.</p>
      <input id="usernameInput" class="w-full border border-gray-300 rounded p-2" placeholder="Enter a nickname" />
      <button id="signinConfirm"
        class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Continue</button>
      <button id="signinCancel" class="w-full px-4 py-2 text-sm text-gray-500">Maybe later</button>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const tabs = document.querySelectorAll('.tab');
    const pages = {
      main: 'page-main',
      map: 'page-map',
      profile: 'page-profile',
      settings: 'page-settings'
    };
    let map = null;
    let mapReady = false;

    function switchTab(tab) {
      tabs.forEach(t => {
        const active = t.dataset.tab === tab;
        t.classList.toggle('text-green-600', active);
        t.classList.toggle('text-gray-500', !active);
        document.getElementById(pages[t.dataset.tab]).classList.toggle('hidden', !active);
      });
      if (tab === 'map' && !mapReady) initMap();
    }

    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
    switchTab('main');

    const resultDiv = document.getElementById('result');
    document.getElementById('scanBtn').addEventListener('click', () => {
      resultDiv.textContent = 'üì∑ Scanner coming soon‚Ä¶';
      resultDiv.classList.remove('hidden');
    });
    document.getElementById('quickMapBtn').addEventListener('click', () => switchTab('map'));

    function initMap() {
      const mapContainer = document.getElementById('map');
      mapContainer.innerHTML = '<p class="text-center p-4">üìç Getting your location‚Ä¶</p>';

      if (!navigator.geolocation) {
        mapContainer.innerHTML = '<p class="text-center p-4 text-red-600">Geolocation not supported.</p>';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude: lat, longitude: lon } = pos.coords;
          mapContainer.innerHTML = '';
          map = L.map('map').setView([lat, lon], 10);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
          }).addTo(map);

          L.marker([lat, lon]).addTo(map).bindPopup('You are here').openPopup();

          // Reverse geocode to get user's city
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
              const userCity = data.address.city || data.address.town || data.address.village || '';
              loadSitesFilteredByCity(userCity);
            })
            .catch(() => {
              loadSitesFilteredByCity(''); // fallback
            });
        },
        () => {
          mapContainer.innerHTML = '<p class="text-center p-4 text-red-600">Location error. Allow access and try again.</p>';
        }
      );

      mapReady = true;
    }

    function loadSitesFilteredByCity(userCity) {
      fetch('data/crv_centers_address_only.json')
        .then(res => res.json())
        .then(data => {
          let matches = data.filter(site => site.city.toLowerCase() === userCity.toLowerCase());

          if (matches.length === 0 && userCity) {
            const grouped = data.reduce((acc, site) => {
              acc[site.city] = acc[site.city] || [];
              acc[site.city].push(site);
              return acc;
            }, {});
            const fallbackCity = Object.keys(grouped).find(c => c.toLowerCase().includes(userCity.toLowerCase().slice(0, 3)));
            matches = grouped[fallbackCity] || [];
          }

          // Geocode each match to get real coordinates
          matches.forEach(site => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`)
              .then(res => res.json())
              .then(loc => {
                if (loc && loc.length > 0) {
                  const lat = parseFloat(loc[0].lat);
                  const lon = parseFloat(loc[0].lon);
                  L.marker([lat, lon])
                    .addTo(map)
                    .bindPopup(`<strong>${site.name}</strong><br>${site.address}<br><a href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.full_address)}' target='_blank'>Open in Maps</a>`);
                }
              });
          });
        });
    }
  </script>

</body>

</html>