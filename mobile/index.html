<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RecycleRight¬†CA</title>

    <!-- TailwindCSS 3 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#16a34a" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <style>
      /* ----------  Global Styles  ---------- */
      html,body{height:100%;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent}
      body{background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 35%,#f0fdf4 100%);color:#1f2937}
      body.dark{background:#111827;color:white}
      body.dark .bg-card{background:#1f2937!important}
      body.dark .text-muted{color:#9ca3af!important}

      /* Glass morphic card */
      .bg-card{background:rgba(255,255,255,0.8);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}

      /* Animations */
      .animate-fade{animation:fadeIn 0.6s ease both}
      .animate-pop{animation:pop 0.45s ease-out both}
      @keyframes fadeIn{from{opacity:0}to{opacity:1}}
      @keyframes pop{0%{transform:scale(.85);opacity:0}100%{transform:scale(1);opacity:1}}
      @keyframes bounce{0%,100%{transform:translateY(-25%)}50%{transform:translateY(0)}}

      /* Ripple effect for buttons */
      .ripple{position:relative;overflow:hidden}
      .ripple:after{content:"";position:absolute;background:rgba(255,255,255,0.4);border-radius:50%;transform:scale(0);opacity:0;pointer-events:none;animation:ripple 600ms ease-out}
      @keyframes ripple{to{transform:scale(4);opacity:0}}
    </style>
  </head>

  <body class="h-full flex flex-col">
    <!-- ----------  HEADER  ---------- -->
    <header class="relative z-20 shadow-sm">
      <div class="h-16 bg-gradient-to-br from-green-600 to-emerald-500 flex items-center justify-center text-white">
        <h1 class="text-2xl font-semibold tracking-tight animate-fade flex items-center gap-2">
          <span class="material-icons-outlined text-3xl">recycling</span>
          RecycleRight&nbsp;CA
        </h1>
      </div>
    </header>

    <!-- ----------  MAIN PAGES CONTAINER  ---------- -->
    <main id="pages" class="flex-1 overflow-y-auto pb-20"> <!-- bottom padding so nav doesn't overlap -->
      <!-- Home  -->
      <section id="page-main" class="p-6 space-y-6 max-w-lg mx-auto animate-fade">
        <div class="text-center space-y-2">
          <h2 class="text-2xl font-bold">Your Pocket Recycling Coach</h2>
          <p class="text-muted">Snap a product and instantly learn the best way to dispose of it.</p>
        </div>

        <div class="w-full space-y-4 flex flex-col items-center">
          <button id="scanBtn" class="relative ripple w-full max-w-xs flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-2xl shadow-lg hover:from-green-600 hover:to-emerald-700 transition-all text-lg font-medium">
            <span class="material-icons-outlined">photo_camera</span>
            Snap Item
          </button>
        </div>

        <section id="result" class="hidden w-full bg-card rounded-2xl shadow-lg animate-pop"></section>
      </section>

      <!-- Camera Overlay  -->
      <div id="camera" class="fixed inset-0 bg-black/90 hidden z-50 flex flex-col">
        <video id="videoPreview" autoplay playsinline class="flex-1 object-cover w-full"></video>
        <!-- Close -->
        <button id="closeCamera" class="absolute top-4 right-4 text-white/80 text-4xl font-bold">&times;</button>
        <!-- Capture -->
        <div class="w-full flex justify-center pb-10 pt-4">
          <button id="snapBtn" class="w-20 h-20 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 border-4 border-white shadow-xl hover:scale-105 transition-transform"></button>
        </div>
      </div>

      <div id="loadingSpinner" class="hidden text-center p-6 animate-fade">
        <p class="text-lg">üîç Analyzing image&hellip;</p>
      </div>

      <!-- Map -->
      <section id="page-map" class="hidden p-0">
        <div id="map" style="height: calc(100vh - 112px);" class="w-full"></div>
      </section>

      <!-- Collection -->
      <section id="page-collection" class="hidden p-6 space-y-6 max-w-xl mx-auto">
        <h2 class="text-xl font-bold text-center">My Collection</h2>
        <div id="collectionList" class="grid gap-4"></div>
      </section>

      <!-- Profile -->
      <section id="page-profile" class="hidden p-6 space-y-6 max-w-xl mx-auto">
        <h2 class="text-xl font-bold">Profile</h2>
        <div id="profileContent" class="bg-card p-6 rounded-2xl shadow-lg text-center space-y-4"></div>
      </section>

      <!-- Settings -->
      <section id="page-settings" class="hidden p-6 space-y-6 max-w-xl mx-auto">
        <h2 class="text-xl font-bold">Settings</h2>
        <div class="flex items-center justify-between bg-card px-4 py-3 rounded-xl shadow">
          <label for="darkModeToggle" class="text-lg font-medium flex items-center gap-2">
            <span class="material-icons-outlined">dark_mode</span>
            Dark Mode
          </label>
          <input type="checkbox" id="darkModeToggle" class="w-5 h-5">
        </div>
      </section>
    </main>

    <!-- ----------  BOTTOM NAV  ---------- -->
    <nav class="fixed bottom-0 inset-x-0 h-16 bg-white/80 backdrop-blur border-t border-gray-200 shadow-inner flex justify-around items-center text-sm z-30">
      <button data-tab="main" class="tab flex flex-col items-center text-green-600 gap-0.5">
        <span class="material-icons-outlined text-2xl">home</span>
        <span>Main</span>
      </button>
      <button data-tab="map" class="tab flex flex-col items-center text-gray-500 gap-0.5">
        <span class="material-icons-outlined text-2xl">map</span>
        <span>Map</span>
      </button>
      <button data-tab="collection" class="tab flex flex-col items-center text-gray-500 gap-0.5">
        <span class="material-icons-outlined text-2xl">collections</span>
        <span>Collection</span>
      </button>
      <button data-tab="profile" class="tab flex flex-col items-center text-gray-500 gap-0.5">
        <span class="material-icons-outlined text-2xl">person</span>
        <span>Profile</span>
      </button>
      <button data-tab="settings" class="tab flex flex-col items-center text-gray-500 gap-0.5">
        <span class="material-icons-outlined text-2xl">settings</span>
        <span>Settings</span>
      </button>
    </nav>

    <!-- ----------  MODALS  ---------- -->
    <!-- Sign‚Äëin gate (nickname) -->
    <div id="signinModal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
      <div class="bg-card rounded-2xl shadow-xl w-80 p-6 space-y-4 text-center animate-pop">
        <h3 class="text-lg font-semibold">Sign&nbsp;In</h3>
        <p class="text-sm text-muted">Sign in to save history, earn points, and rise in rank.</p>
        <input id="usernameInput" class="w-full border border-gray-300 rounded p-2" placeholder="Enter a nickname" />
        <button id="signinConfirm" class="w-full px-4 py-2 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-md hover:to-emerald-700">Continue</button>
        <button id="signinCancel" class="w-full px-4 py-2 text-sm text-muted">Maybe later</button>
      </div>
    </div>

    <!-- Auth (email/pass & google) -->
    <div id="authPopup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
      <div class="bg-card rounded-2xl shadow-xl p-6 w-80 animate-pop relative text-center">
        <button id="closeAuth" class="absolute top-2 right-2 text-muted hover:text-gray-700 text-2xl">&times;</button>
        <h2 id="authTitle" class="text-xl font-bold mb-4">Sign&nbsp;In</h2>
        <input id="emailInput" type="email" placeholder="Email" class="w-full mb-3 p-2 border rounded" />
        <input id="passwordInput" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded" />
        <button id="authMainBtn" class="w-full mb-3 px-4 py-2 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded hover:to-emerald-700">Login</button>
        <button id="googleBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 flex items-center justify-center gap-2">
          <span class="material-icons-outlined">google</span>
          Google
        </button>
        <p id="switchAuthMode" class="text-sm mt-4 text-blue-600 cursor-pointer underline">Signup</p>
      </div>
    </div>

    <!-- How/Why & Collection Popups (same IDs kept) -->
    <div id="howToPopup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
      <div class="bg-card rounded-2xl shadow-xl p-6 w-80 text-center animate-pop relative">
        <button id="closeHowTo" class="absolute top-2 right-2 text-muted hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-xl font-bold text-blue-700 mb-4">How&nbsp;To¬†Recycle</h2>
        <p id="howToText" class="text-muted"></p>
      </div>
    </div>
    <div id="whyPopup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
      <div class="bg-card rounded-2xl shadow-xl p-6 w-80 text-center animate-pop relative">
        <button id="closeWhy" class="absolute top-2 right-2 text-muted hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-xl font-bold text-green-700 mb-4">Why?</h2>
        <p id="whyText" class="text-muted"></p>
      </div>
    </div>
    <div id="collectionPopup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
      <div class="bg-card rounded-2xl shadow-xl p-6 w-80 text-center animate-pop relative">
        <button id="closeCollectionPopup" class="absolute top-2 right-2 text-muted hover:text-gray-700 text-2xl">&times;</button>
        <img id="popupImage" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover shadow" />
        <h2 id="popupName" class="text-xl font-bold mb-1"></h2>
        <p id="popupType" class="text-muted mb-4"></p>
        <button id="deleteItemBtn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Delete¬†from¬†Collection</button>
      </div>
    </div>

    <!-- ----------  SCRIPTS  ---------- -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- The entire original JS logic is preserved below to maintain functionality -->
    <script>
      /* ---------------------------  ORIGINAL SCRIPT  --------------------------- */
      //  (‚ÄºÔ∏è Do not modify logic; only minimal style tweaks like .ripple effect)  
      const firebaseConfig={apiKey:"AIzaSyB9dQshTk_TtTHH3yi1Oj72TcinxuAYbEg",authDomain:"recyclerightca.firebaseapp.com",projectId:"recyclerightca",appId:"1:680884147195:web:b1e0036607dd514908b15e",storageBucket:"recyclerightca.firebasestorage.app",messagingSenderId:"680884147195"};
      firebase.initializeApp(firebaseConfig);
      const auth=firebase.auth();
      const db=firebase.firestore();
      let stream=null;
      const tabs=document.querySelectorAll('.tab');
      const pages={main:'page-main',map:'page-map',profile:'page-profile',settings:'page-settings',collection:'page-collection'};
      let map=null;let mapReady=false;const GEMINI_API_KEY="AIzaSyCteI1RtEohJ7bMCNcJt3sUdROp_ZlVx4E";
      let signupMode=false;let capturedBase64;
      /* ---------------------------  PROFILE & COLLECTION  --------------------------- */
      async function refreshProfile(){const profileContent=document.getElementById('profileContent');const user=auth.currentUser;if(user){const streakData=await fetchStreak(user.uid);const points=streakData.pt;const{name:levelName,badge}=calculateLevel(points);let streakBadge='';if(streakData.current>=90)streakBadge='üî• 90-Day Master';else if(streakData.current>=30)streakBadge='üèÜ 30-Day Legend';else if(streakData.current>=7)streakBadge='ü•á 7-Day Champ';profileContent.innerHTML=`<div class="space-y-6 flex flex-col items-center"><div class="rounded-full bg-green-100 w-32 h-32 flex items-center justify-center text-5xl shadow-inner animate-bounce">${badge}</div><div class="text-muted text-center"><p class="text-2xl font-bold mb-2">${user.email}</p><p class="text-lg">Points: <span id="pointsCount" class="text-green-700 font-semibold">${points}</span></p><p class="text-lg">Level: <span class="text-blue-700 font-semibold">${levelName}</span></p><p class="text-lg">üî• Current Streak: <span class="font-semibold">${streakData.current}</span> days</p><p class="text-lg">üèÜ Longest Streak: <span class="font-semibold">${streakData.longest}</span> days</p><p class="text-lg">‚ùÑÔ∏è Streak Freeze: <span class="font-semibold">${streakData.freeze?'Available':'None'}</span></p>${streakBadge?`<p class="mt-2 text-green-600 font-bold">${streakBadge}</p>`:''}<div id="freezeSection" class="mt-4"></div></div><button onclick="logout()" class="px-6 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Sign Out</button></div>`;if(!streakData.freeze){document.getElementById('freezeSection').innerHTML=`<button onclick="buyStreakFreeze()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Buy Streak Freeze (50 pts)</button>`}}else{profileContent.innerHTML=`<div class="space-y-6 flex flex-col items-center"><p class="text-muted text-lg">You are currently signed out.</p><button onclick="openAuthPopup()" class="px-6 py-2 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-md hover:to-emerald-700">Sign In</button></div>`;}}
      async function refreshCollection(){const collectionList=document.getElementById('collectionList');collectionList.innerHTML='<p class="text-muted text-center w-full">Loading your collection...</p>';const user=auth.currentUser;if(!user){collectionList.innerHTML='<p class="text-muted text-center w-full">Sign in to view your collection.</p>';return;}const snapshot=await db.collection('users').doc(user.uid).collection('collection').orderBy('timestamp','desc').get();if(snapshot.empty){collectionList.innerHTML='<p class="text-muted text-center w-full">No items yet. Start scanning!</p>';return;}collectionList.innerHTML='';snapshot.forEach(doc=>{const data=doc.data();const emoji=data.type==='rec'?'‚ôªÔ∏è':data.type==='nrec'?'‚ùå':'üíµ';const itemDiv=document.createElement('div');itemDiv.className='bg-card p-4 rounded-xl shadow flex items-center gap-4 cursor-pointer hover:bg-white/90 transition';itemDiv.innerHTML=`<img src="${data.image}" alt="${data.name}" class="w-16 h-16 rounded object-cover shadow"><div><p class="text-lg font-semibold">${data.name}</p><p class="text-muted">${emoji} ${data.type.toUpperCase()}</p></div>`;itemDiv.onclick=()=>openCollectionPopup(data.name,data.image,data.type,doc.id);collectionList.appendChild(itemDiv);});}
      function openCollectionPopup(name,image,type,docId){document.getElementById('popupImage').src=image;document.getElementById('popupName').textContent=name;document.getElementById('popupType').textContent=(type==='rec'?'‚ôªÔ∏è Recyclable':type==='nrec'?'‚ùå Non-Recyclable':'üíµ CRV Eligible');document.getElementById('deleteItemBtn').onclick=async()=>{const user=auth.currentUser;if(!user)return;await db.collection('users').doc(user.uid).collection('collection').doc(docId).delete();document.getElementById('collectionPopup').classList.add('hidden');refreshCollection();};document.getElementById('collectionPopup').classList.remove('hidden');}
      document.getElementById('closeCollectionPopup').onclick=()=>{document.getElementById('collectionPopup').classList.add('hidden');};
      /* ---------------------------  STREAKS & POINTS (unchanged) --------------------------- */
      async function buyStreakFreeze(){const user=auth.currentUser;if(!user)return;const userRef=db.collection('users').doc(user.uid);try{await db.runTransaction(async(transaction)=>{const doc=await transaction.get(userRef);if(!doc.exists)throw new Error("User doc missing");const data=doc.data();const points=data.points||0;const freezeAvailable=data.streakFreezeAvailable||false;if(freezeAvailable)throw new Error("You already have a Streak Freeze.");if(points<50)throw new Error("Not enough points!");transaction.update(userRef,{points:points-50,streakFreezeAvailable:true});});const popup=document.createElement('div');popup.textContent='‚ùÑÔ∏è Streak Freeze Purchased!';popup.className='fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white font-bold py-4 px-6 rounded-xl shadow-xl animate-bounce z-50';document.body.appendChild(popup);setTimeout(()=>{popup.remove();refreshProfile();},2000);}catch(e){alert(e.message||"Error purchasing freeze");}}
      async function updateStreak(userId){const userRef=db.collection('users').doc(userId);await db.runTransaction(async(transaction)=>{const userDoc=await transaction.get(userRef);const today=new Date().toISOString().slice(0,10);const yesterday=new Date(Date.now()-86400000).toISOString().slice(0,10);if(!userDoc.exists){transaction.set(userRef,{currentStreak:1,longestStreak:1,lastScanDate:today,streakFreezeAvailable:false});showPlusOne();}else{const data=userDoc.data();const lastScanDate=data.lastScanDate||'';let currentStreak=data.currentStreak||0;let longestStreak=data.longestStreak||0;let freezeAvailable=data.streakFreezeAvailable||false;if(lastScanDate===today){return;}else if(lastScanDate===yesterday){currentStreak+=1;showPlusOne();}else{if(freezeAvailable){freezeAvailable=false;showPlusOne();}else{currentStreak=1;showPlusOne();}}if(currentStreak>longestStreak){longestStreak=currentStreak;}transaction.update(userRef,{currentStreak,longestStreak,lastScanDate:today,streakFreezeAvailable:freezeAvailable});}});}async function fetchStreak(userId){const userDoc=await db.collection('users').doc(userId).get();if(userDoc.exists){const data=userDoc.data();return{current:data.currentStreak||0,longest:data.longestStreak||0,freeze:data.streakFreezeAvailable||false,pt:data.points||0}}return{current:0,longest:0,freeze:false}}async function addPointsToUser(userId,amount=5){const userRef=db.collection('users').doc(userId);await db.runTransaction(async(transaction)=>{const doc=await transaction.get(userRef);if(!doc.exists)return;const currentPoints=doc.data().points||0;transaction.update(userRef,{points:currentPoints+amount});});}
      function showPlusOne(){const plusOne=document.createElement('div');plusOne.textContent='+1üî•';plusOne.className='fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl text-green-600 font-bold animate-bounce';document.body.appendChild(plusOne);setTimeout(()=>plusOne.remove(),1500);}

      /* ---------------------------  TAB ROUTER --------------------------- */
      function switchTab(tab){if(tab!=='main'){document.getElementById('camera').classList.add('hidden');}if(stream&&tab!=='main'){stream.getTracks().forEach(track=>track.stop());stream=null;const videoElement=document.getElementById('videoPreview');if(videoElement)videoElement.srcObject=null;}tabs.forEach(t=>{const active=t.dataset.tab===tab;t.classList.toggle('text-green-600',active);t.classList.toggle('text-gray-500',!active);document.getElementById(pages[t.dataset.tab]).classList.toggle('hidden',!active);});if(tab==='map'&&!mapReady)initMap();if(tab==='profile')refreshProfile();if(tab==='collection')refreshCollection();}
      tabs.forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));switchTab('main');

      /* ---------------------------  CAMERA & SCAN  --------------------------- */
      document.getElementById('scanBtn').addEventListener('click',async()=>{const video=document.getElementById('videoPreview');const snapBtn=document.getElementById('snapBtn');document.getElementById('camera').classList.remove('hidden');stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});video.srcObject=stream;snapBtn.onclick=async()=>{const canvas=document.createElement('canvas');canvas.width=video.videoWidth;canvas.height=video.videoHeight;canvas.getContext('2d').drawImage(video,0,0);stream.getTracks().forEach(track=>track.stop());video.srcObject=null;document.getElementById('camera').classList.add('hidden');document.getElementById('loadingSpinner').classList.remove('hidden');const base64=canvas.toDataURL('image/jpeg').split(',')[1];capturedBase64=base64;sendToGemini(base64);};});document.getElementById('closeCamera').addEventListener('click',()=>{const video=document.getElementById('videoPreview');if(stream){stream.getTracks().forEach(track=>track.stop());stream=null;}video.srcObject=null;document.getElementById('camera').classList.add('hidden');});
      /* ---------------------------  GEMINI  --------------------------- */
      async function sendToGemini(base64img){const body={contents:{parts:[{inline_data:{mime_type:'image/jpeg',data:base64img}},{text:`Analyze this item. Detect the item, detect whether it is recyclable or not.\nIf the item is recyclable, determine if it most likely is CRV. If it is, estimate return amount money.\nHere is a list of items usually listed as CRV:\n  - Glass Beer and other malt bottles\n  - Glass wine coolers\n  - Plastic Soda bottles and aluminum cans\n  - Plastic water bottles\n  - Plastic sports drinks bottles\n  - Tea and coffee drinks\n  - Juice cans and bottles (100% juice containers need to be less than 46 ounces)\n  - Vegetable juice (less than 16 ounces)\n\nPLEASE ONLY RESPOND WITH ONE OF THESE:\n[RECYCABLE, (ITEM NAME)]\n[NON-R, (ITEM NAME)]\n[CRV, (ESTIMATED-MONEY), (ITEM NAME)]\n\nExample:\n[RECYCABLE, Plastic Lid]\n[NON-R, Metal Water Bottle]\n[CRV, $0.20, Plastic Water Bottle]`}]}};try{const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const data=await res.json();const text=data.candidates[0]?.content?.parts[0]?.text.trim();showResult(text);}catch(err){console.error('Gemini error:',err);const resultDiv=document.getElementById('result');resultDiv.innerHTML='‚ö†Ô∏è Error analyzing image.';resultDiv.classList.remove('hidden');}finally{document.getElementById('loadingSpinner').classList.add('hidden');}}

      /* ---------------------------  RESULT UI --------------------------- */
      async function showResult(text){const resultDiv=document.getElementById('result');resultDiv.classList.remove('hidden');resultDiv.classList.add('fixed','inset-0','flex','flex-col','items-center','justify-center','text-white','text-center','p-6','z-50');resultDiv.classList.remove('bg-card');if(text.startsWith('[RECYCABLE')){const material=text.split(',')[1].replace(']','').trim();resultDiv.style.backgroundColor='#16a34a';resultDiv.innerHTML=`<div class="text-7xl mb-6 animate-bounce">‚ôªÔ∏è</div><div class="text-3xl font-bold mb-2">Recyclable</div><div class="text-lg">Detected: <strong>${material}</strong></div><button onclick="askWhyExplanation('${material}','RECYCABLE')" class="mt-6 px-4 py-2 bg-yellow-400 text-white rounded-md hover:bg-yellow-500">Learn Why</button><button onclick="askHowToRecycle('${material}','RECYCABLE')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">How To</button><button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-green-700 font-semibold rounded-xl">Close</button>`;const user=auth.currentUser;if(user){await updateStreak(user.uid);await addPointsToUser(user.uid);await addToCollection(user.uid,material,'rec',`data:image/jpeg;base64,${capturedBase64}`);}refreshProfile();}else if(text.startsWith('[NON-R')){const item=text.split(',')[1].replace(']','').trim();resultDiv.style.backgroundColor='#dc2626';resultDiv.innerHTML=`<div class="text-7xl mb-6 animate-bounce">‚ùå</div><div class="text-3xl font-bold mb-2">Not Recyclable</div><div class="text-lg">Detected: <strong>${item}</strong></div><button onclick="askWhyExplanation('${item}','NON-R')" class="px-4 py-2 bg-yellow-400 text-white rounded-md hover:bg-yellow-500">Learn Why</button><button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-red-700 font-semibold rounded-xl">Close</button>`;const user=auth.currentUser;if(user){await updateStreak(user.uid);await addToCollection(user.uid,item,'nrec',`data:image/jpeg;base64,${capturedBase64}`);}refreshProfile();}else if(text.startsWith('[CRV')){const refund=text.split(',')[1];const itemName=text.split(',')[2].replace(']','').trim();resultDiv.style.backgroundColor='#facc15';resultDiv.innerHTML=`<div class="text-7xl mb-6 animate-bounce">üíµ</div><div class="text-3xl font-bold mb-2">CRV Eligible</div><div class="text-lg">Refund: <strong>${refund}</strong></div><div class="text-lg">Detected: <strong>${itemName}</strong></div><button onclick="askWhyExplanation('${itemName}','CRV')" class="mt-6 px-4 py-2 bg-green-400 text-white rounded-md hover:bg-green-500">Learn Why</button><button onclick="askHowToRecycle('${itemName}','CRV')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">How To</button><button onclick="closeResult();switchTab('map');" class="mt-6 px-6 py-3 bg-white text-yellow-700 font-semibold rounded-xl">Find Nearest Center</button>`;const user=auth.currentUser;if(user){await updateStreak(user.uid);await addPointsToUser(user.uid);await addToCollection(user.uid,itemName,'crv',`data:image/jpeg;base64,${capturedBase64}`);}refreshProfile();}else{resultDiv.style.backgroundColor='#6b7280';resultDiv.innerHTML=`<div class="text-7xl mb-6">‚ùì</div><div class="text-3xl font-bold mb-2">Unknown</div><div class="text-lg">Could not recognize clearly.</div><button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl">Close</button>`;}}
      function closeResult(){const resultDiv=document.getElementById('result');resultDiv.classList.add('hidden');resultDiv.classList.remove('fixed','inset-0','flex','flex-col','items-center','justify-center','text-white','z-50');resultDiv.style.backgroundColor='';resultDiv.innerHTML='';}

      /* ---------------------------  HOW & WHY POPUP  --------------------------- */
      document.getElementById('closeWhy').onclick=()=>{document.getElementById('whyPopup').classList.add('hidden');};document.getElementById('closeHowTo').onclick=()=>{document.getElementById('howToPopup').classList.add('hidden');};
      async function askWhyExplanation(itemName,type){let reason=(type==='RECYCABLE')?'can be recyclable':'cannot be recyclable';if(type==='CRV'){reason='can be recycled with CRV refund.';}const prompt=`Explain to the user: Explain in 3 short sentences of why ${itemName} ${reason}.\nAnswer in this format:\n\n[2 SENTENCE RESPONSE]`;
        const body={contents:[{parts:[{text:prompt}]}]};try{const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const data=await res.json();const explanation=data.candidates[0]?.content?.parts[0]?.text.trim()||'Could not fetch explanation.';document.getElementById('whyText').textContent=explanation;document.getElementById('whyPopup').classList.remove('hidden');}catch(err){document.getElementById('whyText').textContent='‚ö†Ô∏è Failed to load explanation.';document.getElementById('whyPopup').classList.remove('hidden');}}
      function askHowToRecycle(itemName,type){const style=(type==='CRV')?'how to recycle AND get refund at centers':'how to properly recycle curbside or center';const prompt=`Explain to a normal user in 2 short sentences: How to recycle ${itemName} (${style}).`;const body={contents:[{parts:[{text:prompt}]}]};fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(res=>res.json()).then(data=>{const explanation=data.candidates[0]?.content?.parts[0]?.text.trim()||'Could not load instructions.';document.getElementById('howToText').textContent=explanation;document.getElementById('howToPopup').classList.remove('hidden');}).catch(err=>{console.error('How To popup error:',err.message);document.getElementById('howToText').textContent='Failed to load instructions.';document.getElementById('howToPopup').classList.remove('hidden');});}

      /* ---------------------------  MAP INIT & NEAREST --------------------------- */
      function initMap(){return new Promise(resolve=>{const mapContainer=document.getElementById('map');mapContainer.innerHTML='<p class="text-center p-4">üìç Getting your location‚Ä¶</p>';if(!navigator.geolocation){mapContainer.innerHTML='<p class="text-center p-4 text-red-600">Geolocation not supported.</p>';resolve();return;}navigator.geolocation.getCurrentPosition(pos=>{const{latitude:lat,longitude:lon}=pos.coords;mapContainer.innerHTML='';const loadingMessage=document.createElement('div');loadingMessage.id='mapLoading';loadingMessage.className='absolute top-4 left-1/2 -translate-x-1/2 bg-white text-muted py-2 px-4 rounded-lg shadow-lg';loadingMessage.innerHTML='üîÑ Loading nearby centers...';mapContainer.appendChild(loadingMessage);map=L.map('map').setView([lat,lon],11);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(map);const userIcon=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/727/727634.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});L.marker([lat,lon],{icon:userIcon}).addTo(map).bindPopup('You are here');fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`).then(res=>res.json()).then(data=>{const userCity=data.address.city||data.address.town||data.address.village||'';loadSitesFilteredByCity(userCity).then(()=>{resolve();});}).catch(()=>{loadSitesFilteredByCity('').then(()=>{resolve();});});},()=>{mapContainer.innerHTML='<p class="text-center p-4 text-red-600">Location error. Allow access and try again.</p>';resolve();});mapReady=true;});}
      function loadSitesFilteredByCity(userCity){fetch('data/crv_centers_address_only.json').then(res=>res.json()).then(data=>{let matches=data.filter(site=>site.city.toLowerCase()===userCity.toLowerCase());if(matches.length===0&&userCity){const grouped=data.reduce((acc,site)=>{acc[site.city]=acc[site.city]||[];acc[site.city].push(site);return acc;},{});const fallbackCity=Object.keys(grouped).find(c=>c.toLowerCase().includes(userCity.toLowerCase().slice(0,3)));matches=grouped[fallbackCity]||[];}const recycleIcon=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/1327/1327264.png',iconSize:[28,28],iconAnchor:[14,28],popupAnchor:[0,-28]});matches.forEach(site=>{fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`).then(res=>res.json()).then(loc=>{if(loc&&loc.length>0){const lat=parseFloat(loc[0].lat);const lon=parseFloat(loc[0].lon);const marker=L.marker([lat,lon],{icon:recycleIcon}).addTo(map);marker.bindPopup(`<strong>${site.name}</strong><br>${site.address}<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.full_address)}" target="_blank">Open in Maps</a>`);marker._icon.style.animation="bounce 0.8s";}});});});const loadingElement=document.getElementById('mapLoading');if(loadingElement)loadingElement.remove();}
      async function highlightNearestRecycleCenter(){const res=await fetch('data/crv_centers_address_only.json');const centers=await res.json();navigator.geolocation.getCurrentPosition(async pos=>{const userLat=pos.coords.latitude;const userLon=pos.coords.longitude;let nearest=null;let nearestDist=Infinity;for(const site of centers){const geo=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`).then(r=>r.json());if(geo.length>0){const lat=parseFloat(geo[0].lat);const lon=parseFloat(geo[0].lon);const dist=Math.sqrt((lat-userLat)**2+(lon-userLon)**2);if(dist<nearestDist){nearestDist=dist;nearest={lat,lon,name:site.name,address:site.address,full_address:site.full_address};}}}if(nearest){const recycleIcon=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/1327/1327264.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-28]});const marker=L.marker([nearest.lat,nearest.lon],{icon:recycleIcon}).addTo(map);map.setView([nearest.lat,nearest.lon],15);marker.bindPopup(`<strong>${nearest.name}</strong><br>${nearest.address}<br><a href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nearest.full_address)}' target='_blank'>Open in Maps</a>`).openPopup();}});}

      /* ---------------------------  AUTH POPUP --------------------------- */
      function openAuthPopup(){signupMode=false;document.getElementById('authTitle').textContent='Sign In';document.getElementById('authMainBtn').textContent='Login';document.getElementById('switchAuthMode').textContent='Signup';document.getElementById('authPopup').classList.remove('hidden');}
      document.getElementById('closeAuth').onclick=()=>{document.getElementById('authPopup').classList.add('hidden');};document.getElementById('switchAuthMode').onclick=()=>{signupMode=!signupMode;document.getElementById('authTitle').textContent=signupMode?'Sign Up':'Sign In';document.getElementById('authMainBtn').textContent=signupMode?'Create Account':'Login';document.getElementById('switchAuthMode').textContent=signupMode?'Already have an account? Sign In':'Signup';};document.getElementById('authMainBtn').onclick=()=>{const email=document.getElementById('emailInput').value.trim();const password=document.getElementById('passwordInput').value.trim();if(signupMode){auth.createUserWithEmailAndPassword(email,password).then(userCredential=>{const user=userCredential.user;db.collection('users').doc(user.uid).set({currentStreak:0,longestStreak:0,lastScanDate:'',streakFreezeAvailable:false});document.getElementById('authPopup').classList.add('hidden');refreshProfile();}).catch(e=>alert('Signup error: '+e.message));}else{auth.signInWithEmailAndPassword(email,password).then(userCredential=>{const user=userCredential.user;const userRef=db.collection('users').doc(user.uid);userRef.get().then(doc=>{if(!doc.exists){userRef.set({currentStreak:0,longestStreak:0,lastScanDate:'',streakFreezeAvailable:false});}});document.getElementById('authPopup').classList.add('hidden');refreshProfile();}).catch(e=>alert('Login error: '+e.message));}};document.getElementById('googleBtn').onclick=async()=>{const provider=new firebase.auth.GoogleAuthProvider();try{await auth.signInWithPopup(provider);document.getElementById('authPopup').classList.add('hidden');refreshProfile();}catch(error){console.error('Google Sign-in error:',error.message);alert('Failed to login with Google: '+error.message);} };
      /* ---------------------------  HELPERS --------------------------- */
      function calculateLevel(points){if(points>=200)return{name:'Master Recycler',badge:'üèÜ'};if(points>=100)return{name:'Expert Recycler',badge:'ü•á'};if(points>=50)return{name:'Advanced Recycler',badge:'ü•à'};if(points>=20)return{name:'Rookie Recycler',badge:'ü•â'};return{name:'Beginner',badge:'üéØ'};}
      const darkModeToggle=document.getElementById('darkModeToggle');if(localStorage.getItem('dark_mode')==='true'){document.body.classList.add('dark');darkModeToggle.checked=true;}darkModeToggle.addEventListener('change',()=>{const enabled=darkModeToggle.checked;document.body.classList.toggle('dark',enabled);localStorage.setItem('dark_mode',enabled);});
    </script>
  </body>
</html>
