<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecycleRight CA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="../manifest.webmanifest" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body class="h-full bg-gray-100 flex flex-col">
  <header class="bg-green-600 text-white text-center py-3 shadow-md">
    <h1 class="text-xl font-semibold animate-fade-in">RecycleRight&nbsp;CA</h1>
  </header>

  <main id="pages" class="flex-1 overflow-auto">
    <section id="page-main" class="p-6 space-y-6">
      <div class="text-center max-w-md mx-auto">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Your Pocket Recycling Coach</h2>
        <p class="text-gray-600">Snap a product and find out if it‚Äôs recyclable or refundable!</p>
      </div>
      <div class="w-full max-w-sm mx-auto space-y-4">
        <button id="scanBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-green-600 text-white rounded-xl shadow hover:bg-green-700 transition-all text-lg">
          <span class="material-icons-outlined">photo_camera</span>
          Snap Picture
        </button>
        <button id="profileTab"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-gray-700 text-white rounded-xl shadow hover:bg-gray-800 transition-all text-lg">
          <span class="material-icons-outlined">person</span>
          Profile
        </button>
        <button id="settingsTab"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-gray-400 text-white rounded-xl shadow hover:bg-gray-500 transition-all text-lg">
          <span class="material-icons-outlined">settings</span>
          Settings
        </button>
      </div>
    </section>

    <section id="scannerPage" class="hidden p-6 text-center animate-fade-in">
      <button id="closeScanner" class="absolute top-4 right-4 text-xl">&times;</button>
      <video id="videoPreview" autoplay playsinline class="mx-auto rounded-lg shadow-lg w-full max-w-sm"></video>
      <button id="takePhoto" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
        üì∏ Take Photo
      </button>
    </section>

    <section id="resultPage" class="hidden p-6 text-center animate-fade-in">
      <button id="closeResult" class="absolute top-4 right-4 text-xl">&times;</button>
      <div id="resultIcon" class="text-5xl mb-4">‚ôªÔ∏è</div>
      <div id="resultText" class="text-xl font-semibold mb-2"></div>
      <div id="resultDetail" class="text-gray-600 mb-4"></div>
      <button id="nearestBtn" class="hidden mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Nearest Center
      </button>
    </section>

    <section id="page-map" class="hidden p-0">
      <div id="map" style="height: calc(100vh - 112px);" class="w-full"></div>
    </section>

    <section id="page-profile" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Profile</h2>
      <div id="profileContent" class="bg-white p-4 rounded-lg shadow text-center space-y-2"></div>
    </section>

    <section id="page-settings" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Settings</h2>
      <p>üîß Settings coming soon...</p>
    </section>
  </main>

  <div id="signinModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl w-80 p-6 space-y-4 text-center animate-fade-in">
      <h3 class="text-lg font-semibold">Sign In</h3>
      <p class="text-sm text-gray-600">Sign in to save history, earn points, and rise in rank.</p>
      <input id="usernameInput" class="w-full border border-gray-300 rounded p-2" placeholder="Enter a nickname" />
      <button id="signinConfirm"
        class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Continue</button>
      <button id="signinCancel" class="w-full px-4 py-2 text-sm text-gray-500">Maybe later</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const scanBtn = document.getElementById('scanBtn');
    const scannerPage = document.getElementById('scannerPage');
    const resultPage = document.getElementById('resultPage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultIcon = document.getElementById('resultIcon');
    const resultText = document.getElementById('resultText');
    const resultDetail = document.getElementById('resultDetail');
    const nearestBtn = document.getElementById('nearestBtn');
    const video = document.getElementById('videoPreview');
    const mapSection = document.getElementById('page-map');

    let stream;
    const GEMINI_API_KEY = "AIzaSyCteI1RtEohJ7bMCNcJt3sUdROp_ZlVx4E";

    let map, mapReady = false;

    scanBtn.addEventListener('click', async () => {
      document.getElementById('page-main').classList.add('hidden');
      scannerPage.classList.remove('hidden');
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    });

    document.getElementById('closeScanner').onclick = () => {
      stream.getTracks().forEach(t => t.stop());
      scannerPage.classList.add('hidden');
      document.getElementById('page-main').classList.remove('hidden');
    };

    document.getElementById('takePhoto').addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
      stream.getTracks().forEach(t => t.stop());
      scannerPage.classList.add('hidden');
      loadingSpinner.classList.remove('hidden');
      await sendToGemini(base64);
    });

    document.getElementById('closeResult').onclick = () => {
      resultPage.classList.add('hidden');
      document.getElementById('page-main').classList.remove('hidden');
    };

    nearestBtn.onclick = () => {
      resultPage.classList.add('hidden');
      switchTab('map');
      if (!mapReady) initMap();
    };

    function switchTab(tab) {
      const pages = { main: 'page-main', map: 'page-map' };
      Object.values(pages).forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(pages[tab]).classList.remove('hidden');
    }

    async function sendToGemini(base64img) {
      const prompt = `Analyze this item. Detect the item, detect whether it is recyclable or not.\nIf the item is recyclable, determine if it most likely is CRV. If it is, estimate return amount money.\n\nPLEASE ONLY RESPOND WITH ONE OF THESE:\n[RECYCABLE, (ITEM NAME)]\n[NON-R, (ITEM NAME)]\n[CRV, (ESTIMATED-MONEY)]\n\nExample:\n[RECYCABLE, Plastic Lid]\n[NON-R, Metal Water Bottle]\n[CRV, $0.20]`;

      const body = {
        contents: [{ parts: [{ inline_data: { mime_type: 'image/jpeg', data: base64img } }, { text: prompt }] }]
      };

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        const response = data.candidates[0]?.content?.parts[0]?.text.trim();
        showResult(response);
      } catch (err) {
        showResult('[NON-R, Unknown Item]');
      } finally {
        loadingSpinner.classList.add('hidden');
      }
    }

    function showResult(text) {
      resultPage.classList.remove('hidden');
      let type = text.match(/\[(.*?)\,/i)?.[1];
      let value = text.match(/,\s*(.*?)\]/i)?.[1] || 'Unknown';
      nearestBtn.classList.add('hidden');

      if (type === 'RECYCABLE') {
        resultIcon.textContent = '‚ôªÔ∏è';
        resultText.textContent = `Recyclable Item`;
        resultDetail.textContent = value;
      } else if (type === 'NON-R') {
        resultIcon.textContent = '‚ùå';
        resultText.textContent = `Not Recyclable`;
        resultDetail.textContent = value;
      } else if (type === 'CRV') {
        resultIcon.textContent = 'üíµ';
        resultText.textContent = `CRV Eligible`;
        resultDetail.innerHTML = `Estimated Refund: <strong>${value}</strong>`;
        nearestBtn.classList.remove('hidden');
      } else {
        resultIcon.textContent = '‚ùì';
        resultText.textContent = `Could not recognize item.`;
        resultDetail.textContent = text;
      }
    }

    function initMap() {
      map = L.map('map').setView([37.7749, -122.4194], 11); // default to San Francisco
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lon } = pos.coords;
        map.setView([lat, lon], 12);
        const userIcon = L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/727/727634.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });
        L.marker([lat, lon], { icon: userIcon }).addTo(map).bindPopup('You are here');
      });

      mapReady = true;
    }
  </script>

  <script>
    // POINTS SYSTEM
    let username = localStorage.getItem('rr_username') || '';
    let points = parseInt(localStorage.getItem('rr_points') || '0');

    function refreshProfile() {
      const profileContent = document.getElementById('profileContent');
      profileContent.innerHTML = username ? `
      <p>Welcome, <strong>${username}</strong>!</p>
      <p>Points: <strong>${points}</strong></p>
      <p>Rank: <strong>${rankFor(points)}</strong></p>
      <button onclick="logout()" class="mt-4 bg-gray-300 px-4 py-2 rounded">Sign Out</button>
    ` : `
      <p>You are browsing anonymously.</p>
      <button onclick="showSignin()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">Sign In</button>
    `;
    }

    function rankFor(points) {
      if (points >= 100) return 'Master Recycler';
      if (points >= 50) return 'Expert Recycler';
      if (points >= 20) return 'Junior Recycler';
      return 'Rookie';
    }

    function showSignin() {
      document.getElementById('signinModal').classList.remove('hidden');
    }
    function logout() {
      localStorage.removeItem('rr_username');
      localStorage.removeItem('rr_points');
      username = '';
      points = 0;
      refreshProfile();
    }

    document.getElementById('signinConfirm').onclick = () => {
      const input = document.getElementById('usernameInput').value.trim();
      if (input) {
        username = input;
        points = 0;
        localStorage.setItem('rr_username', username);
        localStorage.setItem('rr_points', '0');
        document.getElementById('signinModal').classList.add('hidden');
        refreshProfile();
      }
    };

    document.getElementById('signinCancel').onclick = () => {
      document.getElementById('signinModal').classList.add('hidden');
    };

    document.getElementById('profileTab').onclick = () => {
      switchTab('profile');
      refreshProfile();
    };

    document.getElementById('settingsTab').onclick = () => {
      switchTab('settings');
    };
  </script>


  <style>
    .animate-fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes bounce {
      0% {
        transform: translateY(-20%);
      }

      50% {
        transform: translateY(0%);
      }

      70% {
        transform: translateY(-10%);
      }

      100% {
        transform: translateY(0);
      }
    }
  </style>
</body>

</html>