<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecycleRight CA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="../manifest.webmanifest" />
  <link rel="apple-touch-icon" href="../icons/icon-192.png" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<style>
  .animate-fade-in {
    animation: fadeIn 0.8s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes bounce {
    0% {
      transform: translateY(-20%);
    }

    50% {
      transform: translateY(0%);
    }

    70% {
      transform: translateY(-10%);
    }

    100% {
      transform: translateY(0);
    }
  }
</style>

<body class="h-full bg-gray-100 flex flex-col">
  <header class="bg-green-600 text-white text-center py-3 shadow-md">
    <h1 class="text-xl font-semibold animate-fade-in">RecycleRight&nbsp;CA</h1>
  </header>

  <main id="pages" class="flex-1 overflow-auto">
    <section id="page-main" class="p-6 space-y-6">
      <div class="text-center max-w-md mx-auto">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Your Pocket Recycling Coach</h2>
        <p class="text-gray-600">Snap a product and find out if it‚Äôs recyclable or refundable!</p>
      </div>
      <div class="w-full max-w-sm mx-auto space-y-4">
        <button id="scanBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-green-600 text-white rounded-xl shadow hover:bg-green-700 transition-all text-lg">
          <span class="material-icons-outlined">photo_camera</span>
          Snap Item
        </button>
        <button id="quickMapBtn"
          class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600 text-white rounded-xl shadow hover:bg-blue-700 transition-all text-lg">
          <span class="material-icons-outlined">map</span>
          Nearest Buy-Back Center
        </button>
      </div>
      <section id="result" class="hidden w-full max-w-md mx-auto bg-white p-4 rounded-lg shadow animate-fade-in"
        style="margin: 0;">
      </section>
    </section>
    <div id="camera" class="hidden p-4 text-center animate-fade-in"></div>
    <div id="loadingSpinner" class="hidden text-center p-4 animate-pulse">
      <p>üîç Analyzing image...</p>
    </div>
    <section id="page-map" class="hidden p-0">
      <div id="map" style="height: calc(100vh - 112px);" class="w-full"></div>
    </section>
    <section id="page-collection" class="hidden p-4 space-y-4">
      <h2 class="text-xl font-bold text-center">My Collection</h2>
      <div id="collectionList" class="grid gap-4"></div>
    </section>
    <section id="page-profile" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Profile</h2>
      <div id="profileContent" class="bg-white p-4 rounded-lg shadow text-center space-y-2"></div>
    </section>
    <section id="page-settings" class="hidden p-6 space-y-4">
      <h2 class="text-xl font-bold">Settings</h2>
      <p>üîß Settings coming soon‚Ä¶</p>
    </section>
  </main>

  <nav class="bg-white shadow-inner border-t border-gray-200 flex justify-around py-2 text-sm">
    <button data-tab="main" class="tab flex flex-col items-center text-green-600">
      <span class="material-icons-outlined text-xl">home</span>
      <span>Main</span>
    </button>
    <button data-tab="map" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">map</span>
      <span>Map</span>
    </button>
    <button data-tab="collection" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">collections</span>
      <span>Collection</span>
    </button>
    <button data-tab="profile" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">person</span>
      <span>Profile</span>
    </button>
    <button data-tab="settings" class="tab flex flex-col items-center text-gray-500">
      <span class="material-icons-outlined text-xl">settings</span>
      <span>Settings</span>
    </button>
  </nav>

  <div id="signinModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl w-80 p-6 space-y-4 text-center animate-fade-in">
      <h3 class="text-lg font-semibold">Sign In</h3>
      <p class="text-sm text-gray-600">Sign in to save history, earn points, and rise in rank.</p>
      <input id="usernameInput" class="w-full border border-gray-300 rounded p-2" placeholder="Enter a nickname" />
      <button id="signinConfirm"
        class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Continue</button>
      <button id="signinCancel" class="w-full px-4 py-2 text-sm text-gray-500">Maybe later</button>
    </div>
  </div>

  <div id="authPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-80 max-w-sm text-center relative animate-fade-in">
      <button id="closeAuth" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      <h2 id="authTitle" class="text-xl font-bold mb-4">Sign In</h2>

      <input id="emailInput" type="email" placeholder="Email" class="w-full mb-3 p-2 border rounded">
      <input id="passwordInput" type="password" placeholder="Password" class="w-full mb-3 p-2 border rounded">

      <button id="authMainBtn"
        class="w-full mb-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Login</button>
      <button id="googleBtn" class="w-full mb-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Login with
        Google</button>

      <p id="switchAuthMode" class="text-sm mt-3 text-blue-600 cursor-pointer underline">Signup</p>
    </div>
  </div>

  <div id="howToPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-80 max-w-sm text-center relative animate-fade-in">
      <button id="closeHowTo" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-xl font-bold text-blue-700 mb-4">How To Recycle</h2>
      <p id="howToText" class="text-gray-700"></p>
    </div>
  </div>

  <div id="collectionPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-80 max-w-sm text-center relative animate-fade-in">
      <button id="closeCollectionPopup"
        class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      <img id="popupImage" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover" />
      <h2 id="popupName" class="text-xl font-bold text-gray-800 mb-2"></h2>
      <p id="popupType" class="text-gray-600 mb-4"></p>
      <button id="deleteItemBtn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Delete from
        Collection</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB9dQshTk_TtTHH3yi1Oj72TcinxuAYbEg",
      authDomain: "recyclerightca.firebaseapp.com",
      projectId: "recyclerightca",
      appId: "1:680884147195:web:b1e0036607dd514908b15e",
      storageBucket: "recyclerightca.firebasestorage.app",
      messagingSenderId: "680884147195"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let stream = null;
    const tabs = document.querySelectorAll('.tab');
    const pages = {
      main: 'page-main',
      map: 'page-map',
      profile: 'page-profile',
      settings: 'page-settings',
      collection: 'page-collection'
    };
    let map = null;
    let mapReady = false;
    const GEMINI_API_KEY = "AIzaSyCteI1RtEohJ7bMCNcJt3sUdROp_ZlVx4E";

    let signupMode = false;

    let capturedBase64;

    async function refreshProfile() {
      const profileContent = document.getElementById('profileContent');
      const user = auth.currentUser;

      if (user) {
        const streakData = await fetchStreak(user.uid);
        const points = streakData.pt;
        const { name: levelName, badge } = calculateLevel(points);

        let streakBadge = '';
        if (streakData.current >= 90) streakBadge = 'üî• 90-Day Master';
        else if (streakData.current >= 30) streakBadge = 'üèÜ 30-Day Legend';
        else if (streakData.current >= 7) streakBadge = 'ü•á 7-Day Champ';

        profileContent.innerHTML = `
      <div class="space-y-6 flex flex-col items-center">
        <div class="rounded-full bg-green-100 w-32 h-32 flex items-center justify-center text-5xl shadow-inner animate-bounce">
          ${badge}
        </div>

        <div class="text-gray-700 text-center">
          <p class="text-2xl font-bold mb-2">${user.email}</p>
          <p class="text-lg">Points: <span id="pointsCount" class="text-green-700 font-semibold">${points}</span></p>
          <p class="text-lg">Level: <span class="text-blue-700 font-semibold">${levelName}</span></p>
          <p class="text-lg">üî• Current Streak: <span class="font-semibold">${streakData.current}</span> days</p>
          <p class="text-lg">üèÜ Longest Streak: <span class="font-semibold">${streakData.longest}</span> days</p>
          <p class="text-lg">‚ùÑÔ∏è Streak Freeze: <span class="font-semibold">${streakData.freeze ? 'Available' : 'None'}</span></p>
          ${streakBadge ? `<p class="mt-2 text-green-600 font-bold">${streakBadge}</p>` : ''}
          <div id="freezeSection" class="mt-4"></div>
        </div>

        <button onclick="logout()" class="px-6 py-2 bg-gray-300 rounded-md hover:bg-gray-400">
          Sign Out
        </button>
      </div>
    `;

        if (!streakData.freeze) {
          document.getElementById('freezeSection').innerHTML = `
        <button onclick="buyStreakFreeze()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
          Buy Streak Freeze (50 pts)
        </button>
      `;
        }
      } else {
        profileContent.innerHTML = `
      <div class="space-y-6 flex flex-col items-center">
        <p class="text-gray-600 text-lg">You are currently signed out.</p>
        <button onclick="openAuthPopup()" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
          Sign In
        </button>
      </div>
    `;
      }
    }

    async function refreshCollection() {
      const collectionList = document.getElementById('collectionList');
      collectionList.innerHTML = '<p class="text-gray-500 text-center w-full">Loading your collection...</p>';

      const user = auth.currentUser;
      if (!user) {
        collectionList.innerHTML = '<p class="text-gray-500 text-center w-full">Sign in to view your collection.</p>';
        return;
      }

      const snapshot = await db.collection('users').doc(user.uid).collection('collection').orderBy('timestamp', 'desc').get();

      if (snapshot.empty) {
        collectionList.innerHTML = '<p class="text-gray-500 text-center w-full">No items yet. Start scanning!</p>';
        return;
      }

      collectionList.innerHTML = '';

      snapshot.forEach(doc => {
        const data = doc.data();
        const emoji = data.type === 'rec' ? '‚ôªÔ∏è' : (data.type === 'nrec' ? '‚ùå' : 'üíµ');

        const itemDiv = document.createElement('div');
        itemDiv.className = 'bg-white p-4 rounded-lg shadow flex items-center gap-4 cursor-pointer hover:bg-gray-100 transition';
        itemDiv.innerHTML = `
      <img src="${data.image}" alt="${data.name}" class="w-16 h-16 rounded object-cover">
      <div>
        <p class="text-lg font-semibold">${data.name}</p>
        <p class="text-gray-500">${emoji} ${data.type.toUpperCase()}</p>
      </div>
    `;

        itemDiv.onclick = () => openCollectionPopup(data.name, data.image, data.type, doc.id);
        collectionList.appendChild(itemDiv);
      });
    }

    function openCollectionPopup(name, image, type, docId) {
      document.getElementById('popupImage').src = image;
      document.getElementById('popupName').textContent = name;
      document.getElementById('popupType').textContent = (type === 'rec' ? '‚ôªÔ∏è Recyclable' : type === 'nrec' ? '‚ùå Non-Recyclable' : 'üíµ CRV Eligible');

      const deleteBtn = document.getElementById('deleteItemBtn');
      deleteBtn.onclick = async () => {
        const user = auth.currentUser;
        if (!user) return;

        await db.collection('users').doc(user.uid).collection('collection').doc(docId).delete();
        document.getElementById('collectionPopup').classList.add('hidden');
        refreshCollection();
      };

      document.getElementById('collectionPopup').classList.remove('hidden');
    }

    document.getElementById('closeCollectionPopup').onclick = () => {
      document.getElementById('collectionPopup').classList.add('hidden');
    };

    async function buyStreakFreeze() {
      const user = auth.currentUser;
      if (!user) return;

      const userRef = db.collection('users').doc(user.uid);

      try {
        await db.runTransaction(async (transaction) => {
          const doc = await transaction.get(userRef);
          if (!doc.exists) throw new Error("User doc missing");

          const data = doc.data();
          const points = data.points || 0;
          const freezeAvailable = data.streakFreezeAvailable || false;

          if (freezeAvailable) throw new Error("You already have a Streak Freeze.");
          if (points < 50) throw new Error("Not enough points!");

          transaction.update(userRef, {
            points: points - 50,
            streakFreezeAvailable: true
          });
        });

        // Success popup
        const popup = document.createElement('div');
        popup.textContent = '‚ùÑÔ∏è Streak Freeze Purchased!';
        popup.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white font-bold py-4 px-6 rounded-xl shadow-xl animate-bounce z-50';
        document.body.appendChild(popup);
        setTimeout(() => {
          popup.remove();
          refreshProfile(); // reload to show changes
        }, 2000);

      } catch (e) {
        alert(e.message || "Error purchasing freeze");
      }
    }

    async function updateStreak(userId) {
      const userRef = db.collection('users').doc(userId);

      await db.runTransaction(async (transaction) => {
        const userDoc = await transaction.get(userRef);
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);

        if (!userDoc.exists) {
          transaction.set(userRef, {
            currentStreak: 1,
            longestStreak: 1,
            lastScanDate: today,
            streakFreezeAvailable: false
          });
          showPlusOne();
        } else {
          const data = userDoc.data();
          const lastScanDate = data.lastScanDate || '';
          let currentStreak = data.currentStreak || 0;
          let longestStreak = data.longestStreak || 0;
          let freezeAvailable = data.streakFreezeAvailable || false;

          if (lastScanDate === today) {
            return;
          } else if (lastScanDate === yesterday) {
            currentStreak += 1;
            showPlusOne();
          } else {
            if (freezeAvailable) {
              freezeAvailable = false;
              showPlusOne();
            } else {
              currentStreak = 1;
              showPlusOne();
            }
          }

          if (currentStreak > longestStreak) {
            longestStreak = currentStreak;
          }

          transaction.update(userRef, {
            currentStreak,
            longestStreak,
            lastScanDate: today,
            streakFreezeAvailable: freezeAvailable
          });
        }
      });
    }

    async function fetchStreak(userId) {
      const userDoc = await db.collection('users').doc(userId).get();
      if (userDoc.exists) {
        const data = userDoc.data();
        return {
          current: data.currentStreak || 0,
          longest: data.longestStreak || 0,
          freeze: data.streakFreezeAvailable || false,
          pt: data.points || 0
        };
      }
      return { current: 0, longest: 0, freeze: false };
    }

    async function addPointsToUser(userId, amount = 5) {
      const userRef = db.collection('users').doc(userId);

      await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(userRef);
        if (!doc.exists) return;

        const currentPoints = doc.data().points || 0;
        transaction.update(userRef, {
          points: currentPoints + amount
        });
      });
    }

    function showPlusOne() {
      const plusOne = document.createElement('div');
      plusOne.textContent = '+1üî•';
      plusOne.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl text-green-600 font-bold animate-bounce';
      document.body.appendChild(plusOne);

      setTimeout(() => plusOne.remove(), 1500);
    }

    function switchTab(tab) {
      if (tab !== 'main') {
        document.getElementById('camera').classList.add('hidden');
      }
      // Stop camera if leaving scanner
      if (stream && tab !== 'main') {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        const videoElement = document.getElementById('videoPreview');
        if (videoElement) videoElement.srcObject = null;
      }
      tabs.forEach(t => {
        const active = t.dataset.tab === tab;
        t.classList.toggle('text-green-600', active);
        t.classList.toggle('text-gray-500', !active);
        document.getElementById(pages[t.dataset.tab]).classList.toggle('hidden', !active);
      });
      if (tab === 'map' && !mapReady) initMap();
      if (tab === 'profile') refreshProfile();
      if (tab === 'collection') refreshCollection();
    }
    tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
    switchTab('main');

    async function addToCollection(userId, name, type, base64img) {
      const collectionRef = db.collection('users').doc(userId).collection('collection');

      // Get all items with the same name
      const snapshot = await collectionRef.where('name', '>=', name).where('name', '<=', name + '\uf8ff').get();

      let newName = name;
      let count = 1;
      const nameRegex = new RegExp(`^${name}( \\((\\d+)\\))?$`);

      snapshot.forEach(doc => {
        const existingName = doc.data().name;
        const match = existingName.match(nameRegex);
        if (match) {
          const number = parseInt(match[2]) || 1;
          if (number >= count) {
            count = number + 1;
          }
        }
      });

      if (count > 1) {
        newName = `${name} (${count})`;
      }

      await collectionRef.add({
        name: newName,
        type: type,
        image: 'data:image/jpeg;base64,' + base64img,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    async function loadCollection() {
      const user = auth.currentUser;
      const list = document.getElementById('collectionList');
      list.innerHTML = '';
      if (!user) return;

      const snapshot = await db.collection('users').doc(user.uid).collection('collection').orderBy('timestamp', 'desc').get();

      snapshot.forEach(doc => {
        const { name, type, image } = doc.data();
        const emoji = type === 'rec' ? '‚ôªÔ∏è' : type === 'crv' ? 'üíµ' : '‚ùå';

        const card = document.createElement('div');
        card.className = 'bg-white rounded shadow p-3 cursor-pointer';
        card.innerHTML = `
      <img src="${image}" class="w-full h-32 object-cover rounded mb-2" />
      <div class="text-center font-medium">${emoji} ${name}</div>
    `;

        card.onclick = () => {
          document.getElementById('popupImage').src = image;
          document.getElementById('popupName').textContent = name;
          document.getElementById('popupType').textContent = `Type: ${emoji} ${type.toUpperCase()}`;
          document.getElementById('collectionPopup').classList.remove('hidden');

          document.getElementById('deleteItemBtn').onclick = async () => {
            await db.collection('users').doc(user.uid).collection('collection').doc(name).delete();
            document.getElementById('collectionPopup').classList.add('hidden');
            loadCollection(); // reload
          };
        };

        list.appendChild(card);
      });
    }

    function openAuthPopup() {
      signupMode = false;
      document.getElementById('authTitle').textContent = 'Sign In';
      document.getElementById('authMainBtn').textContent = 'Login';
      document.getElementById('switchAuthMode').textContent = 'Signup';
      document.getElementById('authPopup').classList.remove('hidden');
    }

    document.getElementById('closeAuth').onclick = () => {
      document.getElementById('authPopup').classList.add('hidden');
    };

    document.getElementById('switchAuthMode').onclick = () => {
      signupMode = !signupMode;
      document.getElementById('authTitle').textContent = signupMode ? 'Sign Up' : 'Sign In';
      document.getElementById('authMainBtn').textContent = signupMode ? 'Create Account' : 'Login';
      document.getElementById('switchAuthMode').textContent = signupMode ? 'Already have an account? Sign In' : 'Signup';
    };

    document.getElementById('authMainBtn').onclick = () => {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();

      if (signupMode) {
        auth.createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;
            // Create default Firestore document
            db.collection('users').doc(user.uid).set({
              currentStreak: 0,
              longestStreak: 0,
              lastScanDate: '',
              streakFreezeAvailable: false
            });
            document.getElementById('authPopup').classList.add('hidden');
            refreshProfile();
          })
          .catch(e => alert('Signup error: ' + e.message));
      } else {
        auth.signInWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;
            // Check if user document exists
            const userRef = db.collection('users').doc(user.uid);
            userRef.get().then((doc) => {
              if (!doc.exists) {
                // If no document, create default one
                userRef.set({
                  currentStreak: 0,
                  longestStreak: 0,
                  lastScanDate: '',
                  streakFreezeAvailable: false
                });
              }
            });
            document.getElementById('authPopup').classList.add('hidden');
            refreshProfile();
          })
          .catch(e => alert('Login error: ' + e.message));
      }
    };

    // Profile Tab Behavior
    const profileContent = document.getElementById('profileContent');

    // Call refreshProfile whenever we switch tabs
    document.querySelector('button[data-tab="profile"]').addEventListener('click', () => {
      switchTab('profile');
      refreshProfile();
    });

    function logout() {
      auth.signOut().then(() => {
        refreshProfile();
      });
    }

    document.getElementById('googleBtn').onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();

      try {
        await auth.signInWithPopup(provider);
        document.getElementById('authPopup').classList.add('hidden');
        refreshProfile();
      } catch (error) {
        console.error('Google Sign-in error:', error.message);
        alert('Failed to login with Google: ' + error.message);
      }
    };

    function calculateLevel(points) {
      if (points >= 200) return { name: 'Master Recycler', badge: 'üèÜ' };
      if (points >= 100) return { name: 'Expert Recycler', badge: 'ü•á' };
      if (points >= 50) return { name: 'Advanced Recycler', badge: 'ü•à' };
      if (points >= 20) return { name: 'Rookie Recycler', badge: 'ü•â' };
      return { name: 'Beginner', badge: 'üéØ' };
    }

    const nearestBtn = document.getElementById('nearestBtn');

    const resultDiv = document.getElementById('result');
    const cameraDiv = document.getElementById('camera');
    const loadingSpinner = document.getElementById('loadingSpinner');

    document.getElementById('scanBtn').addEventListener('click', async () => {
      resultDiv.classList.add('hidden');
      cameraDiv.innerHTML = '';
      cameraDiv.classList.remove('hidden');

      const video = document.createElement('video');
      video.setAttribute('autoplay', '');
      video.setAttribute('playsinline', '');
      video.className = 'rounded shadow-md';
      video.style.width = '100%';
      cameraDiv.appendChild(video);

      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;

      const snapBtn = document.createElement('button');
      snapBtn.textContent = 'üì∏ Take Photo';
      snapBtn.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700';
      cameraDiv.appendChild(snapBtn);

      snapBtn.addEventListener('click', async () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        stream.getTracks().forEach(track => track.stop());
        cameraDiv.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
        capturedBase64 = base64; // <-- new
        sendToGemini(base64);
      });
    });

    async function sendToGemini(base64img) {
      const body = {
        contents: [{
          parts: [
            {
              inline_data: {
                mime_type: 'image/jpeg',
                data: base64img
              }
            },
            {
              text: `Analyze this item. Detect the item, detect whether it is recyclable or not.
    If the item is recyclable, determine if it most likely is CRV. If it is, estimate return amount money.
    Here is a list of items usually listed as CRV:
      - Glass Beer and other malt bottles
      - Glass wine coolers
      - Plastic Soda bottles and aluminum cans
      - Plastic water bottles
      - Plastic sports drinks bottles
      - Tea and coffee drinks
      - Juice cans and bottles (100% juice containers need to be less than 46 ounces)
      - Vegetable juice (less than 16 ounces)

    PLEASE ONLY RESPOND WITH ONE OF THESE:
    [RECYCABLE, (ITEM NAME)]
    [NON-R, (ITEM NAME)]
    [CRV, (ESTIMATED-MONEY), (ITEM NAME)]

    Example:
    [RECYCABLE, Plastic Lid]
    [NON-R, Metal Water Bottle]
    [CRV, $0.20, Plastic Water Bottle]`
            }
          ]
        }]
      };

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        const text = data.candidates[0]?.content?.parts[0]?.text.trim();
        showResult(text);

      } catch (err) {
        console.error('Gemini error:', err);
        resultDiv.innerHTML = '‚ö†Ô∏è Error analyzing image.';
        resultDiv.classList.remove('hidden');
      } finally {
        loadingSpinner.classList.add('hidden');
      }
    }

    async function showResult(text) {
      resultDiv.classList.remove('hidden');
      resultDiv.classList.add('fixed', 'top-0', 'left-0', 'w-full', 'h-full', 'flex', 'flex-col', 'items-center', 'justify-center', 'text-white', 'text-center', 'p-6', 'z-50');
      resultDiv.classList.remove('bg-white');

      if (text.startsWith('[RECYCABLE')) {
        const material = text.split(',')[1].replace(']', '').trim();
        resultDiv.style.backgroundColor = '#16a34a'; // Green
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6 animate-bounce">‚ôªÔ∏è</div>
      <div class="text-3xl font-bold mb-2">Recyclable</div>
      <div class="text-lg">Detected: <strong>${material}</strong></div>
      <button onclick="askWhyExplanation('${material}', 'RECYCABLE')" class="mt-6 px-4 py-2 bg-yellow-400 text-white rounded-md hover:bg-yellow-500">Learn Why</button>
      <button onclick="askHowToRecycle('${material}', 'RECYCABLE')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">How To</button>
      <button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-green-700 font-semibold rounded-xl">Close</button>
    `;
        // +5 points for every successful scan
        const user = auth.currentUser;
        if (user) {
          await updateStreak(user.uid);
          await addPointsToUser(user.uid);
          await addToCollection(user.uid, material, 'rec', `data:image/jpeg;base64,${capturedBase64}`);
        }
        refreshProfile();
      } else if (text.startsWith('[NON-R')) {
        const item = text.split(',')[1].replace(']', '').trim();
        resultDiv.style.backgroundColor = '#dc2626'; // Red
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6 animate-bounce">‚ùå</div>
      <div class="text-3xl font-bold mb-2">Not Recyclable</div>
      <div class="text-lg">Detected: <strong>${item}</strong></div>
      <button onclick="askWhyExplanation('${item}', 'NON-R')" class="px-4 py-2 bg-yellow-400 text-white rounded-md hover:bg-yellow-500">Learn Why</button>
      <button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-red-700 font-semibold rounded-xl">Close</button>
    `;
        const user = auth.currentUser;
        if (user) {
          await updateStreak(user.uid);
          await addToCollection(user.uid, item, 'nrec', `data:image/jpeg;base64,${capturedBase64}`);
        }
        refreshProfile();
      } else if (text.startsWith('[CRV')) {
        const refund = text.split(',')[1]
        const itemName = text.split(',')[2].replace(']', '').trim();
        resultDiv.style.backgroundColor = '#facc15'; // Yellow
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6 animate-bounce">üíµ</div>
      <div class="text-3xl font-bold mb-2">CRV Eligible</div>
      <div class="text-lg">Refund: <strong>${refund}</strong></div>
      <button onclick="askWhyExplanation('${itemName}', 'CRV')" class="mt-6 px-4 py-2 bg-yellow-400 text-white rounded-md hover:bg-yellow-500">Learn Why</button>
      <button onclick="askHowToRecycle('${itemName}', 'CRV')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">How To</button>
      <button onclick="closeResult();switchTab('map');" class="mt-6 px-6 py-3 bg-white text-yellow-700 font-semibold rounded-xl">Find Nearest Center</button>
    `;
        // +5 points for every successful scan
        const user = auth.currentUser;
        if (user) {
          await updateStreak(user.uid);
          await addPointsToUser(user.uid);
          await addToCollection(user.uid, itemName, 'crv', `data:image/jpeg;base64,${capturedBase64}`);
        }
        refreshProfile();
      } else {
        resultDiv.style.backgroundColor = '#6b7280'; // Gray fallback
        resultDiv.innerHTML = `
      <div class="text-7xl mb-6">‚ùì</div>
      <div class="text-3xl font-bold mb-2">Unknown</div>
      <div class="text-lg">Could not recognize clearly.</div>
      <button onclick="closeResult()" class="mt-6 px-6 py-3 bg-white text-gray-700 font-semibold rounded-xl">Close</button>
    `;
      }
    }

    function closeResult() {
      resultDiv.classList.add('hidden');
      resultDiv.classList.remove('fixed', 'inset-0', 'flex', 'flex-col', 'items-center', 'justify-center', 'text-white', 'z-50');
      resultDiv.style.backgroundColor = '';
      resultDiv.innerHTML = '';
    }

    function nearestBtnFunc() {
      resultPage.classList.add('hidden');
      switchTab('map');

      if (!mapReady) {
        initMap().then(() => {
          highlightNearestRecycleCenter();
        });
      } else {
        highlightNearestRecycleCenter();
      }
    };

    async function askWhyExplanation(itemName, type) {
      const reason = (type === 'RECYCABLE') ? 'can be recyclable' : 'cannot be recyclable';

      if (type === 'CRV') {
        reason = 'can be recycled with CRV refund.';
      }

      const prompt = `Explain to the user: Explain in 3 short sentences of why ${itemName} ${reason}.
Answer in this format:

[2 SENTENCE RESPONSE]`;

      const body = {
        contents: [{ parts: [{ text: prompt }] }]
      };

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        const explanation = data.candidates[0]?.content?.parts[0]?.text.trim() || 'Could not fetch explanation.';

        document.getElementById('whyText').textContent = explanation;
        document.getElementById('whyPopup').classList.remove('hidden');
      } catch (err) {
        document.getElementById('whyText').textContent = '‚ö†Ô∏è Failed to load explanation.';
        document.getElementById('whyPopup').classList.remove('hidden');
      }
    }

    document.getElementById('closeHowTo').onclick = () => {
      document.getElementById('howToPopup').classList.add('hidden');
    };

    function askHowToRecycle(itemName, type) {
      const style = (type === 'CRV') ? 'how to recycle AND get refund at centers' : 'how to properly recycle curbside or center';

      const prompt = `Explain to a normal user in 2 short sentences: How to recycle ${itemName} (${style}).`;

      const body = {
        contents: [{ parts: [{ text: prompt }] }]
      };

      fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
        .then(res => res.json())
        .then(data => {
          const explanation = data.candidates[0]?.content?.parts[0]?.text.trim() || 'Could not load instructions.';
          document.getElementById('howToText').textContent = explanation;
          document.getElementById('howToPopup').classList.remove('hidden');
        })
        .catch(err => {
          console.error('How To popup error:', err.message);
          document.getElementById('howToText').textContent = 'Failed to load instructions.';
          document.getElementById('howToPopup').classList.remove('hidden');
        });
    }

    function initMap() {
      return new Promise((resolve) => {
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = '<p class="text-center p-4">üìç Getting your location‚Ä¶</p>';

        if (!navigator.geolocation) {
          mapContainer.innerHTML = '<p class="text-center p-4 text-red-600">Geolocation not supported.</p>';
          resolve(); // Still resolve to not freeze
          return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude: lat, longitude: lon } = pos.coords;
          mapContainer.innerHTML = '';
          const loadingMessage = document.createElement('div');
          loadingMessage.id = 'mapLoading';
          loadingMessage.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 bg-white text-gray-700 py-2 px-4 rounded-lg shadow-lg';
          loadingMessage.innerHTML = 'üîÑ Loading nearby centers...';
          mapContainer.appendChild(loadingMessage);
          map = L.map('map').setView([lat, lon], 11);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

          const userIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/727/727634.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
          });

          L.marker([lat, lon], { icon: userIcon }).addTo(map).bindPopup('You are here');

          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
              const userCity = data.address.city || data.address.town || data.address.village || '';
              loadSitesFilteredByCity(userCity).then(() => {
                resolve(); // ‚úÖ Only resolve after loading city centers
              });
            })
            .catch(() => {
              loadSitesFilteredByCity('').then(() => {
                resolve(); // Even if error, still resolve
              });
            });

        }, () => {
          mapContainer.innerHTML = '<p class="text-center p-4 text-red-600">Location error. Allow access and try again.</p>';
          resolve(); // Also resolve if location failed
        });

        mapReady = true;
      });
    }

    function loadSitesFilteredByCity(userCity) {
      fetch('data/crv_centers_address_only.json') // Make sure your JSON is inside /data/
        .then(res => res.json())
        .then(data => {
          let matches = data.filter(site => site.city.toLowerCase() === userCity.toLowerCase());

          if (matches.length === 0 && userCity) {
            const grouped = data.reduce((acc, site) => {
              acc[site.city] = acc[site.city] || [];
              acc[site.city].push(site);
              return acc;
            }, {});
            const fallbackCity = Object.keys(grouped).find(c => c.toLowerCase().includes(userCity.toLowerCase().slice(0, 3)));
            matches = grouped[fallbackCity] || [];
          }

          const recycleIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1327/1327264.png',
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
          });

          matches.forEach(site => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`)
              .then(res => res.json())
              .then(loc => {
                if (loc && loc.length > 0) {
                  const lat = parseFloat(loc[0].lat);
                  const lon = parseFloat(loc[0].lon);
                  const marker = L.marker([lat, lon], { icon: recycleIcon }).addTo(map);
                  marker.bindPopup(`<strong>${site.name}</strong><br>${site.address}<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(site.full_address)}" target="_blank">Open in Maps</a>`);
                  marker._icon.style.animation = "bounce 0.8s"; // ‚ú® Animate when added
                }
              });
          });
        });
      const loadingElement = document.getElementById('mapLoading');
      if (loadingElement) loadingElement.remove();
    }

    async function highlightNearestRecycleCenter() {
      const res = await fetch('data/crv_centers_address_only.json');
      const centers = await res.json();

      navigator.geolocation.getCurrentPosition(async pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        let nearest = null;
        let nearestDist = Infinity;

        for (const site of centers) {
          const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(site.full_address)}`)
            .then(r => r.json());

          if (geo.length > 0) {
            const lat = parseFloat(geo[0].lat);
            const lon = parseFloat(geo[0].lon);
            const dist = Math.sqrt((lat - userLat) ** 2 + (lon - userLon) ** 2);

            if (dist < nearestDist) {
              nearestDist = dist;
              nearest = { lat, lon, name: site.name, address: site.address, full_address: site.full_address };
            }
          }
        }

        if (nearest) {
          const recycleIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/1327/1327264.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          });

          const marker = L.marker([nearest.lat, nearest.lon], { icon: recycleIcon }).addTo(map);
          map.setView([nearest.lat, nearest.lon], 15);
          marker.bindPopup(`<strong>${nearest.name}</strong><br>${nearest.address}<br><a href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nearest.full_address)}' target='_blank'>Open in Maps</a>`).openPopup();
        }
      });
    }

  </script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }

    .animate-fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
  <div id="whyPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-80 relative animate-fade-in">
      <button id="closeWhy" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      <h2 class="text-xl font-bold text-green-700 mb-4">Why?</h2>
      <p id="whyText" class="text-gray-700"></p>
    </div>
  </div>
  <script>
    document.getElementById('closeWhy').onclick = () => {
      document.getElementById('whyPopup').classList.add('hidden');
    };
  </script>
</body>

</html>